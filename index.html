<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RingCentral Social Media Marketing Hub</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Inter+Tight:wght@300;400;500;600;700&display=swap');
        
        :root {
            --ocean-blue: #004b87;
            --rc-blue: #0669ff;
            --rc-orange: #ff8a00;
            --soft-peach: #faf5f2;
            --warm-black: #1d1d1f;
            --card-border: #e2e8f0;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--soft-peach); 
            color: var(--warm-black);
            margin: 0;
        }

        .bg-ocean { background-color: var(--ocean-blue); }
        .bg-rc-blue { background-color: var(--rc-blue); }
        .text-rc-blue { color: var(--rc-blue); }
        .text-warm-black { color: var(--warm-black); }
        
        .btn-primary { 
            background-color: var(--rc-orange); 
            color: white; 
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(255, 138, 0, 0.25);
            font-weight: 700;
        }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }

        .card { 
            background: white; 
            border-radius: 12px; 
            border: 1px solid var(--card-border); 
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.03);
        }
        
        .input-field { 
            border: 1px solid #d1d9e2; 
            border-radius: 8px; 
            padding: 8px 12px; 
            width: 100%; 
            font-size: 0.875rem;
            color: var(--warm-black);
            background-color: #ffffff;
        }
        .input-field:focus { 
            border-color: var(--rc-blue); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(6, 105, 255, 0.1); 
        }

        .tab-btn {
            font-weight: 600;
            color: #64748b;
            position: relative;
            padding: 16px 20px;
            transition: all 0.2s;
        }
        .tab-btn.active { color: var(--rc-blue); }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--rc-blue);
            border-radius: 4px 4px 0 0;
        }

        #tab-library, #tab-library * { 
            font-family: 'Inter Tight', sans-serif !important; 
            font-size: 11px !important; 
            line-height: 1.6 !important;
            font-style: normal !important; 
        }

        .label-documentation {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #64748b;
            margin-bottom: 4px;
            display: block;
        }

        .label-strategic {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--ocean-blue);
            margin-bottom: 8px;
            display: block;
        }

        .preview-text {
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            word-break: break-all;
        }

        .limit-pill { font-size: 10px; padding: 2px 6px; border-radius: 999px; font-weight: bold; }
        .limit-ok { background: #f1f5f9; color: #64748b; }
        .limit-warn { background: #fee2e2; color: #ef4444; }

        .row-locked { background-color: #f8fafc; opacity: 0.8; }
        .locked-field { pointer-events: none !important; background-color: #f1f5f9 !important; color: #94a3b8 !important; }

        .health-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .health-good { background-color: #10b981; }
        .health-warn { background-color: #f59e0b; }
        .health-critical { background-color: #ef4444; }

        .priority-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #e0f2fe; color: #0369a1; font-weight: 800; text-transform: uppercase; margin-left: 6px;}

        /* Standardized Hub Styling - Size 12 */
        .hub-cell-text { font-size: 12px !important; }
        .hub-input { font-size: 12px !important; border: 1px solid #e2e8f0; border-radius: 4px; padding: 2px 4px; background: #fff; width: 100%; }
        .hub-header-text th { font-size: 12px !important; font-weight: 800 !important; text-transform: uppercase; color: #fff; vertical-align: middle; border-right: 1px solid rgba(255,255,255,0.1); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
    </style>
    <script>
        // GLOBAL SCOPE UI Functions
        window.showTab = function(id) {
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const target = document.getElementById('tab-' + id);
            if (target) target.classList.remove('hidden');
            const btn = document.getElementById('btn-' + id);
            if (btn) btn.classList.add('active');
            window.dispatchEvent(new CustomEvent('tabChanged', { detail: id }));
        };

        window.loadDraftBudget = function() {
            const y = document.getElementById('goal-year')?.value;
            const m = document.getElementById('goal-month')?.value;
            if (y && m && window.draftBudgetPeriods) {
                const key = `${y}-${m}`;
                document.getElementById('budget-total').value = window.draftBudgetPeriods[key] || "10000";
            }
        };

        window.saveDraftBudget = function() {
            const y = document.getElementById('goal-year')?.value;
            const m = document.getElementById('goal-month')?.value;
            if (y && m) {
                const key = `${y}-${m}`;
                if (!window.draftBudgetPeriods) window.draftBudgetPeriods = {};
                window.draftBudgetPeriods[key] = document.getElementById('budget-total').value;
            }
        };

        window.updateFinalURL = function() {
            const dest = document.getElementById('destination-url')?.value;
            const bmid = document.getElementById('summary-bmid')?.innerText;
            const display = document.getElementById('final-url-display');
            if (dest && bmid && bmid !== '---' && bmid !== 'GENERATING...') {
                const sep = dest.includes('?') ? '&' : '?';
                if (display) display.innerText = `${dest}${sep}BMID=${bmid}`;
            } else if (display) {
                display.innerText = "---";
            }
        };

        window.updateNaming = function() {
            const type = document.getElementById('input-type')?.value || '';
            const loc = document.getElementById('input-location')?.value || '';
            const obj = document.getElementById('input-objective')?.value || '';
            const stg = document.getElementById('input-stage')?.value || '';
            const vendor = document.getElementById('input-vendor')?.value || '';
            const product = document.getElementById('input-product')?.value || '';
            const promo = document.getElementById('input-promo')?.value.trim().replace(/\s+/g, '') || '';
            const detail = document.getElementById('input-objdetail')?.value || '';
            const dateRef = document.getElementById('input-date')?.value || '';

            let dateStr = "MMYY";
            if (dateRef) { 
                const parts = dateRef.split('-');
                dateStr = parts[1] + parts[0].substring(2); 
            }

            // Naming convention requirements:
            // Location, Stage, Product, and General Objective: ALL CAPS
            // Others: Title Case
            const formattedParts = [
                type.charAt(0).toUpperCase() + type.slice(1).toLowerCase(), // Type
                loc.toUpperCase(), // Location - ALL CAPS
                obj.toUpperCase(), // General Objective - ALL CAPS
                stg.toUpperCase(), // Stage - ALL CAPS
                vendor.charAt(0).toUpperCase() + vendor.slice(1).toLowerCase(), // Vendor
                product.toUpperCase() // Product: ALL CAPS
            ];
            
            if (promo) formattedParts.push(promo.charAt(0).toUpperCase() + promo.slice(1));
            formattedParts.push(detail.charAt(0).toUpperCase() + detail.slice(1).toLowerCase(), dateStr);

            const result = formattedParts.join('_').substring(0, 80);
            const nDisplay = document.getElementById('current-naming-display');
            if (nDisplay) nDisplay.innerText = result;
            
            const nLim = document.getElementById('name-limit-pill');
            if (nLim) {
                nLim.innerText = `${result.length} / 80`;
                nLim.className = `limit-pill ${result.length >= 75 ? 'limit-warn' : 'limit-ok'}`;
            }

            // BMID Logic (Uppercase for identification standards)
            let prefix = (type === "OLV" || type === "CTV") ? type : "PS";
            const tsStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
            const randVal = Math.floor(Math.random() * 1000) + 1;
            const randStr = randVal.toString().padStart(10, '0');
            const bmidResult = `${prefix}${vendor}${tsStr}${randStr}`.toUpperCase().substring(0, 31);
            
            const bDisplay = document.getElementById('summary-bmid');
            if (bDisplay) bDisplay.innerText = bmidResult;
            
            const bLim = document.getElementById('bmid-limit-pill');
            if (bLim) {
                bLim.innerText = `${bmidResult.length} / 31`;
                bLim.className = `limit-pill ${bmidResult.length >= 30 ? 'limit-warn' : 'limit-ok'}`;
            }
            window.updateFinalURL();
        };

        window.handleVendorChange = function() { window.updateNaming(); };
    </script>
</head>
<body class="antialiased">

    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-ocean text-white py-6 px-8 shadow-md">
            <div class="max-w-[1800px] mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight text-white">Marketing Planning Hub</h1>
                    <p class="text-blue-100 text-[10px] uppercase font-bold tracking-[0.25em] mt-1 text-white opacity-80">Documentation • Strategy • Media Library</p>
                </div>
                <div id="header-sync-info" class="text-xs font-mono opacity-70 italic">Establishing Connection...</div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white border-b border-[#e2e8f0] sticky top-0 z-50">
            <div class="max-w-[1800px] mx-auto flex px-8 space-x-2 overflow-x-auto whitespace-nowrap">
                <button onclick="showTab('planner')" class="tab-btn active text-sm" id="btn-planner">Campaign Planner</button>
                <button onclick="showTab('active-campaigns')" class="tab-btn text-sm" id="btn-active-campaigns">Summary Hub</button>
                <button onclick="showTab('performance-visualizer')" class="tab-btn text-sm" id="btn-performance-visualizer">Analytics Dashboard</button>
                <button onclick="showTab('library')" class="tab-btn text-sm" id="btn-library">Audience Library</button>
                <button onclick="showTab('creative')" class="tab-btn text-sm" id="btn-creative">Creative Specs</button>
                <button onclick="showTab('bmid-history')" class="tab-btn text-sm" id="btn-bmid-history">BMID Registry</button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto w-full p-8 space-y-8 flex-grow">

            <!-- TAB: PLANNER -->
            <div id="tab-planner" class="space-y-8">
                <!-- Configuration Card -->
                <div class="card p-8 border-t-4 border-rc-blue shadow-sm">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-lg font-bold flex items-center text-ocean">
                            <svg class="w-5 h-5 mr-2 text-rc-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                            Plan Configuration
                        </h2>
                        <button onclick="saveCampaignToHub()" class="btn-primary px-8 py-2.5 rounded-full text-xs uppercase tracking-widest">
                            SAVE TO SUMMARY HUB
                        </button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="space-y-1"><label class="label-documentation">Campaign Type</label><select id="input-type" class="input-field" onchange="updateNaming()"><option value="PaidSocial">PaidSocial</option><option value="CTV">CTV</option><option value="Display">Display</option><option value="OLV">OLV</option><option value="OrganicSocial">OrganicSocial</option><option value="Native">Native</option></select></div>
                        <div class="space-y-1"><label class="label-documentation">Location</label><select id="input-location" class="input-field" onchange="updateNaming()"><option value="US">US Only</option><option value="CA">CA Only</option><option value="US_CA">US & CA</option><option value="INT">International</option></select></div>
                        <div class="space-y-1"><label class="label-documentation">General Objective</label><select id="input-objective" class="input-field" onchange="updateNaming()"><option value="PR">Prospecting (PR)</option><option value="RT">Retargeting (RT)</option><option value="EX">Expansion (EX)</option></select></div>
                        <div class="space-y-1"><label class="label-documentation">Stage</label><select id="input-stage" class="input-field" onchange="updateNaming()"><option value="AW">Awareness</option><option value="CO">Consideration</option><option value="DE">Demand</option></select></div>
                        <div class="space-y-1"><label class="label-documentation">Vendor</label><select id="input-vendor" class="input-field" onchange="handleVendorChange()"><option value="LinkedIn">LinkedIn</option><option value="Meta">Meta</option><option value="YouTube">YouTube</option><option value="DemandGen">Google DemandGen</option><option value="StackAdapt">StackAdapt</option></select></div>
                        <div class="space-y-1"><label class="label-documentation">Product</label><select id="input-product" class="input-field" onchange="updateNaming()"><option value="REX">RingEX</option><option value="RCX">Contact Center</option><option value="AIR">RingSense AI</option><option value="ALL">All/General</option></select></div>
                        <div class="space-y-1"><label class="label-documentation">Promo / Initiative</label><input type="text" id="input-promo" class="input-field" placeholder="Optional" oninput="updateNaming()"></div>
                        <div class="space-y-1"><label class="label-documentation">Initiative Detail</label><select id="input-objdetail" class="input-field" onchange="updateNaming()"><option value="Integrated">Integrated</option><option value="Brand">Brand</option><option value="Evergreen">Evergreen</option><option value="ABM">ABM</option><option value="AWS">AWS</option></select></div>
                        <div class="space-y-1"><label class="label-documentation">Media Objective</label><select id="input-mediaobj" class="input-field" onchange="updateNaming()"><option value="WEBTRAFFIC">Webtraffic</option><option value="LGF">LGF</option><option value="REACH">Reach</option><option value="CONV">Conversion</option></select></div>
                        <div class="space-y-1"><label class="label-documentation">Ad Type</label><select id="input-adtype" class="input-field" onchange="updateNaming()"><option value="IMAGE">Image</option><option value="VIDEO">Video</option><option value="CTV">CTV</option><option value="CAROUSEL">Carousel</option></select></div>
                        <div class="space-y-1"><label class="label-documentation text-rc-blue font-bold">Naming Date Ref (MMYY)</label><input type="month" id="input-date" class="input-field border-rc-blue" onchange="updateNaming()"></div>
                    </div>
                </div>

                <!-- Strategic Tracking Card (14px) -->
                <div class="card p-8 border-l-4 border-rc-blue shadow-lg">
                    <h2 class="text-lg font-bold mb-8 text-ocean flex items-center"><svg class="w-5 h-5 mr-2 text-rc-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>Strategic Identifiers & Tracking</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <div class="space-y-8">
                            <div><div class="flex justify-between items-center mb-2"><label class="label-strategic">Campaign Naming Preview</label><span id="name-limit-pill" class="limit-pill limit-ok">0 / 80</span></div><div class="bg-gray-50 p-4 rounded-xl border border-gray-100 preview-text text-ocean font-bold" id="current-naming-display">GENERATING...</div></div>
                            <div><div class="flex justify-between items-center mb-2"><label class="label-strategic">Active BMID (Unique)</label><span id="bmid-limit-pill" class="limit-pill limit-ok">0 / 31</span></div><div class="bg-blue-50 p-4 rounded-xl border border-blue-100 preview-text text-rc-blue font-bold" id="summary-bmid">---</div></div>
                        </div>
                        <div class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="label-strategic">TCP L1</label><input type="text" id="input-tcp-l1" class="input-field" placeholder="Mapping"></div>
                                <div><label class="label-strategic">TCP L3</label><input type="text" id="input-tcp-l3" class="input-field" placeholder="Tactical"></div>
                            </div>
                            <div class="space-y-1">
                                <label class="label-strategic">Destination URL Base</label>
                                <input type="text" id="destination-url" placeholder="https://..." class="input-field font-mono" oninput="updateFinalURL()">
                            </div>
                            <div class="p-5 bg-rc-navy rounded-xl border border-ocean shadow-inner">
                                <label class="label-strategic !text-blue-300">Final Tracking Integrated URL</label>
                                <p id="final-url-display" class="preview-text text-green-400 mt-1 font-bold">---</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Goal Summary Card -->
                <div class="card p-8 border-l-4 border-rc-blue">
                    <h2 class="text-lg font-bold mb-6 text-ocean flex items-center"><svg class="w-5 h-5 mr-2 text-rc-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Goal Summary</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                        <div><label class="label-documentation">Total Budget</label><input type="number" id="budget-total" class="input-field font-bold" value="10000" onchange="saveDraftBudget()"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label-documentation">Year</label><input type="number" id="goal-year" value="2026" class="input-field" onchange="loadDraftBudget()"></div>
                            <div><label class="label-documentation">Period</label><select id="goal-month" class="input-field font-bold" onchange="loadDraftBudget()"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option><option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option></select></div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 md:col-span-2">
                            <div><label class="label-documentation">CPM Goal</label><input type="text" id="goal-cpm" placeholder="$0.00" class="input-field"></div>
                            <div><label class="label-documentation">CPC Goal</label><input type="text" id="goal-cpc" placeholder="$0.00" class="input-field"></div>
                            <div><label class="label-documentation">LtO Target</label><input type="text" id="goal-lto" placeholder="0%" class="input-field"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: SUMMARY HUB -->
            <div id="tab-active-campaigns" class="hidden space-y-6">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-3xl font-bold text-ocean">Summary Hub</h2>
                    <div class="flex gap-3">
                         <select id="hub-month-filter" class="input-field py-1 text-xs w-44" onchange="renderCampaignHub()"><option value="all">Filter: All Periods</option>${monthsOptions.map(m => `<option value="${m}">${m}</option>`).join('')}</select>
                         <select id="hub-product-filter" class="input-field py-1 text-xs w-36" onchange="renderCampaignHub()"><option value="all">Product: All</option><option value="REX">RingEX</option><option value="RCX">Contact Center</option><option value="AIR">RingSense AI</option></select>
                    </div>
                </div>
                <div id="campaign-hub-container"></div>
            </div>

            <!-- TAB: AUDIENCE LIBRARY -->
            <div id="tab-library" class="hidden space-y-8">
                <div class="flex items-center justify-between">
                    <h2 class="text-3xl font-bold text-ocean">Audience & ICP Library</h2>
                    <span class="text-[10px] font-bold text-rc-blue bg-blue-50 px-4 py-2 rounded-full uppercase border border-blue-100">Standard Documentation</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="audience-grid">
                    <div class="audience-card card p-8 border-t-8 border-blue-600">
                        <h3 class="font-bold text-lg mb-4 text-ocean">REX: (ICP)</h3>
                        <div class="space-y-4">
                            <div><p class="label-documentation text-rc-blue mb-1 font-bold uppercase">Target Inclusions</p><div id="icp-rex-inc" contenteditable="true" class="bg-gray-50 p-3 rounded-lg border border-gray-100" oninput="syncLibraryUpdate('REX', 'inclusion', this.innerText)">IT Decision Makers (CIO, CTO, VP IT, IT Director), Infrastructure Managers, Unified Comms Interests.</div></div>
                            <div><p class="label-documentation text-red-500 mb-1 font-bold uppercase">Standard Exclusions</p><div id="icp-rex-exc" contenteditable="true" class="bg-[#fff9f9] p-3 rounded-lg border border-[#fee2e2]" oninput="syncLibraryUpdate('REX', 'exclusion', this.innerText)">Company (Current Jobs): Fuze, Microsoft, Cisco, 8x8, RingCentral, Zoom, Webex, Dialpad, NICE, Vonage, Ring Central, GoTo Group, Zoom, Five9, Amazon Connect, Nextiva, Talkdesk, Prem-to-Cloud; Job Seniorities: Entry, Senior, Training, Unpaid</div></div>
                        </div>
                    </div>
                    <div class="audience-card card p-8 border-t-8 border-green-600">
                        <h3 class="font-bold text-lg mb-4 text-ocean">RCX: (ICP)</h3>
                        <div class="space-y-4">
                            <div><p class="label-documentation text-rc-blue mb-1 font-bold uppercase">Target Inclusions</p><div id="icp-rcx-inc" contenteditable="true" class="bg-gray-50 p-3 rounded-lg border border-gray-100" oninput="syncLibraryUpdate('RCX', 'inclusion', this.innerText)">Customer Experience Leaders, VP Success, Support Operations, Call Center Directors.</div></div>
                            <div><p class="label-documentation text-red-500 mb-1 font-bold uppercase">Standard Exclusions</p><div id="icp-rcx-exc" contenteditable="true" class="bg-[#fff9f9] p-3 rounded-lg border border-[#fee2e2]" oninput="syncLibraryUpdate('RCX', 'exclusion', this.innerText)">Company (Current Jobs): Fuze, Microsoft, Cisco, 8x8, RingCentral, Zoom, Webex, Dialpad, NICE, Vonage, Ring Central, GoTo Group, Zoom, Five9, Amazon Connect, Nextiva, Talkdesk, Prem-to-Cloud; Job Seniorities: Entry, Senior, Training, Unpaid</div></div>
                        </div>
                    </div>
                    <div class="audience-card card p-8 border-t-8 border-purple-600">
                        <h3 class="font-bold text-lg mb-4 text-ocean">AIR: (ICP)</h3>
                        <div class="space-y-4">
                            <div><p class="label-documentation text-rc-blue mb-1 font-bold uppercase">Target Inclusions</p><div id="icp-air-inc" contenteditable="true" class="bg-gray-50 p-3 rounded-lg border border-gray-100" oninput="syncLibraryUpdate('AIR', 'inclusion', this.innerText)">Sales Leadership, RevOps, Sales Enablement Managers, Conversation AI Interests.</div></div>
                            <div><p class="label-documentation text-red-500 mb-1 font-bold uppercase">Standard Exclusions</p><div id="icp-air-exc" contenteditable="true" class="bg-[#fff9f9] p-3 rounded-lg border border-[#fee2e2]" oninput="syncLibraryUpdate('AIR', 'exclusion', this.innerText)">Company (Current Jobs): Fuze, Microsoft, Cisco, 8x8, RingCentral, Zoom, Webex, Dialpad, NICE, Vonage, Ring Central, GoTo Group, Zoom, Five9, Amazon Connect, Nextiva, Talkdesk, Prem-to-Cloud; Job Seniorities: Entry, Senior, Training, Unpaid</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: BMID REGISTRY -->
            <div id="tab-bmid-history" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-ocean">BMID Strategy Registry</h2>
                <div id="bmid-registry-container"></div>
            </div>

        </main>
    </div>

    <!-- UI Overlay Elements -->
    <div id="notification-area" class="fixed top-8 right-8 space-y-3 z-[9999]"></div>
    <div id="sync-indicator" class="text-[10px] bg-white border p-2 rounded shadow-lg text-gray-400">Sync: <span id="sync-status">Connected</span></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Initialization
        let db, auth, user;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rc-marketing-hub-final-v10';

        // Global State
        window.hubCampaigns = [];
        window.bmidRegistry = [];
        window.draftBudgetPeriods = {};
        window.monthsOptions = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December", "Q1", "Q2", "Q3", "Q4"];

        // ATTACH FUNCTIONS TO WINDOW IMMEDIATELY (Fixing ReferenceErrors)
        window.updateHubPeriodView = function(id, key) {
            const c = window.hubCampaigns.find(x => x.id === id);
            if (c) {
                c.currentViewKey = key;
                renderCampaignHub();
            }
        };

        window.saveCampaignToHub = saveCampaignToHub;
        window.toggleLock = toggleLock;
        window.deleteCampaign = deleteCampaign;
        window.syncLibraryUpdate = syncLibraryUpdate;
        window.updateHubField = updateHubField;
        window.updateActualPeriodValue = updateActualPeriodValue;

        async function initCloudSync() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config || "{}");
                if (!firebaseConfig.apiKey) throw new Error("Offline");
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        document.getElementById('header-sync-info').innerText = "Live Cloud Synced";
                        document.getElementById('sync-status').innerText = "Connected";
                        setupListeners();
                    }
                });
            } catch (err) { 
                document.getElementById('header-sync-info').innerText = "Strategy Hub Offline";
            }
        }

        function setupListeners() {
            const publicDoc = doc(db, 'artifacts', appId, 'public', 'data', 'app_config', 'master_data');
            onSnapshot(publicDoc, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.hubCampaigns = data.campaigns || [];
                    window.bmidRegistry = data.registry || [];
                    renderCampaignHub();
                    renderRegistry();
                }
            });
        }

        async function syncToCloud() {
            if (!user) return;
            try {
                const publicDoc = doc(db, 'artifacts', appId, 'public', 'data', 'app_config', 'master_data');
                await setDoc(publicDoc, { campaigns: window.hubCampaigns, registry: window.bmidRegistry, lastUpdated: new Date().toISOString() });
                document.getElementById('sync-status').innerText = "Commit Saved";
                setTimeout(() => document.getElementById('sync-status').innerText = "Connected", 1000);
            } catch (err) { console.error("Cloud Error", err); }
        }

        const getLibraryText = (product, type) => {
            const id = `icp-${product.toLowerCase()}-${type === 'inclusion' ? 'inc' : 'exc'}`;
            const el = document.getElementById(id);
            return el ? el.innerText : 'Refer Documentation';
        };

        async function saveCampaignToHub() {
            const productInput = document.getElementById('input-product').value;
            const vendor = document.getElementById('input-vendor').value;
            const name = document.getElementById('current-naming-display').innerText;
            const bmid = document.getElementById('summary-bmid').innerText;
            const tcpL1 = document.getElementById('input-tcp-l1').value;
            const tcpL3 = document.getElementById('input-tcp-l3').value;
            const month = document.getElementById('goal-month').value;
            const year = document.getElementById('goal-year').value;
            
            const inclusion = getLibraryText(productInput, 'inclusion');
            const exclusion = getLibraryText(productInput, 'exclusion');

            const key = `${year}-${month}`;
            const newGoalSet = {
                budget: document.getElementById('budget-total').value || '10000',
                spend: 0,
                cpc: '-', cpm: '-', lto: '-',
                goalCpc: document.getElementById('goal-cpc').value.replace(/[$,%]/g, '') || '-',
                goalCpm: document.getElementById('goal-cpm').value.replace(/[$,%]/g, '') || '-',
                goalLto: document.getElementById('goal-lto').value.replace(/[$,%]/g, '') || '-'
            };

            // BMID Registry Logging
            window.bmidRegistry.unshift({ date: new Date().toLocaleString(), month, year, product: productInput, name, bmid, vendor, tcpL1, tcpL3 });

            let existing = window.hubCampaigns.find(c => c.name === name && c.bmid === bmid);
            
            if (existing) {
                if (!existing.periods) existing.periods = {};
                existing.periods[key] = newGoalSet;
                if (!existing.month.includes(month)) existing.month.push(month);
                existing.currentViewKey = key;
            } else {
                const campaign = {
                    id: Date.now(), status: 'Planning', locked: false, name, bmid, product: productInput, vendor, tcpL1, tcpL3,
                    month: [month], year: year,
                    currentViewKey: key,
                    introDate: document.getElementById('input-intro-date')?.value || '-',
                    launchDate: document.getElementById('input-launch-date')?.value || '-',
                    endDate: document.getElementById('input-end-date')?.value || '-',
                    periods: { [key]: newGoalSet }, 
                    finalUrl: document.getElementById('final-url-display').innerText, 
                    inclusion, exclusion
                };
                window.hubCampaigns.unshift(campaign);
            }

            await syncToCloud();
            notify("Campaign Data Registered & Saved.");
        }

        function renderCampaignHub() {
            const container = document.getElementById('campaign-hub-container');
            if(!container) return;
            container.innerHTML = `<div class="card overflow-hidden shadow-xl"><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead class="bg-ocean text-white uppercase font-bold"><tr class="hub-header-text"><th class="p-4 border-r border-white/5 w-24">Assets</th><th class="p-4 border-r border-white/5 w-24">Copy</th><th class="p-4 w-12 text-center">Health</th><th class="p-4 w-16 text-center">Status</th><th class="p-4 text-center w-28 font-bold text-xs">Period</th><th class="p-4">Prod</th><th class="p-4 w-48 font-bold text-xs">Campaign Name</th><th class="p-4 font-bold text-xs">BMID</th><th class="p-4 w-40 font-bold text-xs">Inclusion (ICP)</th><th class="p-4 w-40 font-bold text-xs">Exclusion (ICP)</th><th class="p-4 bg-rc-blue/10">Budget (Σ)</th><th class="p-4 bg-green-600/10 text-green-900 font-bold">Actual (Σ)</th><th class="p-4 text-indigo-700 font-bold">Goal CPC</th><th class="p-4">Actual CPC</th><th class="p-4 text-indigo-700 font-bold">Goal CPM</th><th class="p-4">Actual CPM</th><th class="p-4 font-bold">Actual LtO</th><th class="p-4 text-center font-bold text-xs">Actions</th></tr></thead><tbody class="divide-y divide-[#eef2f6]" id="campaign-hub-body"></tbody></table></div></div>`;
            const body = document.getElementById('campaign-hub-body');
            
            (window.hubCampaigns || []).forEach(c => {
                if (!c.currentViewKey) c.currentViewKey = `${c.year}-${c.month[0]}`;
                const activeData = c.periods?.[c.currentViewKey] || { budget: 0, spend: 0, cpc: '-', cpm: '-', lto: '-', goalCpc: '-', goalCpm: '-', goalLto: '-' };

                let periodSelect = `<select onchange="window.updateHubPeriodView(${c.id}, this.value)" class="hub-input font-bold">`;
                Object.keys(c.periods || {}).forEach(k => {
                    const monthName = k.split('-')[1];
                    periodSelect += `<option value="${k}" ${c.currentViewKey === k ? 'selected' : ''}>${monthName}</option>`;
                });
                periodSelect += `</select>`;

                const row = document.createElement('tr');
                row.className = c.locked ? 'row-locked' : '';
                row.innerHTML = `
                    <td class="p-4 border-r border-[#eef2f6]"><input type="text" value="${c.assetLink||''}" class="hub-input w-full ${c.locked?'locked-field':''}" onblur="updateHubField(${c.id}, 'assetLink', this.value)"></td>
                    <td class="p-4 border-r border-[#eef2f6]"><input type="text" value="${c.copyLink||''}" class="hub-input w-full ${c.locked?'locked-field':''}" onblur="updateHubField(${c.id}, 'copyLink', this.value)"></td>
                    <td class="p-4 text-center"><div class="health-indicator mx-auto ${activeData.budget > 0 && activeData.spend/activeData.budget > 1.1 ? 'health-critical' : 'health-good'}"></div></td>
                    <td class="p-4"><select onchange="updateHubField(${c.id}, 'status', this.value)" class="hub-input font-bold ${c.locked?'locked-field':''}"><option value="Planning" ${c.status==='Planning'?'selected':''}>Planning</option><option value="Active" ${c.status==='Active'?'selected':''}>Active</option><option value="Waiting for creative" ${c.status==='Waiting for creative'?'selected':''}>Waiting for creative</option><option value="Blocked" ${c.status==='Blocked'?'selected':''}>Blocked</option><option value="Ended" ${c.status==='Ended'?'selected':''}>Ended</option></select></td>
                    <td class="p-2">${periodSelect}</td>
                    <td class="p-4 font-bold text-rc-blue hub-cell-text">${c.product}</td>
                    <td class="p-4 font-bold hub-cell-text w-48 break-words text-xs">${c.name}</td>
                    <td class="p-4 font-mono text-rc-blue hub-cell-text text-xs">${c.bmid}</td>
                    <td class="p-4 font-bold"><div contenteditable="${!c.locked}" class="p-1 rounded border hub-cell-text ${c.locked?'locked-field':''}" onblur="updateHubField(${c.id}, 'inclusion', this.innerText)">${c.inclusion}</div></td>
                    <td class="p-4 font-bold"><div contenteditable="${!c.locked}" class="p-1 rounded border hub-cell-text ${c.locked?'locked-field':''}" onblur="updateHubField(${c.id}, 'exclusion', this.innerText)">${c.exclusion}</div></td>
                    <td class="p-4 font-bold hub-cell-text">$${parseFloat(activeData.budget).toLocaleString()}</td>
                    <td class="p-4 bg-green-50 font-bold"><input type="text" value="$${activeData.spend}" class="hub-input w-20 font-bold text-green-700" onblur="updateActualPeriodValue(${c.id}, 'spend', this.value)"></td>
                    <td class="p-4 text-center hub-cell-text font-bold text-indigo-700">$${activeData.goalCpc || '-'}</td>
                    <td class="p-4"><input type="text" value="$${activeData.cpc}" class="hub-input w-12" onblur="updateActualPeriodValue(${c.id}, 'cpc', this.value)"></td>
                    <td class="p-4 text-center hub-cell-text font-bold text-indigo-700">$${activeData.goalCpm || '-'}</td>
                    <td class="p-4"><input type="text" value="$${activeData.cpm}" class="hub-input w-12" onblur="updateActualPeriodValue(${c.id}, 'cpm', this.value)"></td>
                    <td class="p-4"><input type="text" value="${activeData.lto}%" class="hub-input w-12" onblur="updateActualPeriodValue(${c.id}, 'lto', this.value)"></td>
                    <td class="p-4 text-center space-x-2 flex justify-center"><button onclick="toggleLock(${c.id})" class="${c.locked?'text-rc-blue':'text-gray-300'}"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" /></svg></button><button onclick="deleteCampaign(${c.id})" class="text-red-300">×</button></td>`;
                body.appendChild(row);
            });
        }

        function toggleLock(id) { const c = window.hubCampaigns.find(x => x.id === id); if (c) { c.locked = !c.locked; renderCampaignHub(); syncToCloud(); } }
        
        async function updateHubField(id, field, val) { 
            const c = window.hubCampaigns.find(x => x.id === id); 
            if (c) { c[field] = val; await syncToCloud(); } 
        }

        async function updateActualPeriodValue(id, field, val) { 
            const c = window.hubCampaigns.find(x => x.id === id); 
            if (!c || !c.currentViewKey) return; 
            const key = c.currentViewKey;
            if (!c.periods) c.periods = {}; 
            if (!c.periods[key]) c.periods[key] = { budget: 0, spend: 0, cpc: '-', cpm: '-', lto: '-' }; 
            const cleanVal = val.replace(/[$,%]/g, '');
            c.periods[key][field] = cleanVal; 
            renderCampaignHub();
            await syncToCloud(); 
        }

        function deleteCampaign(id) { if(confirm("Permanently delete documentation?")) { window.hubCampaigns = window.hubCampaigns.filter(x => x.id !== id); renderCampaignHub(); syncToCloud(); } }
        
        function syncLibraryUpdate(product, field, text) { (window.hubCampaigns || []).forEach(c => { if (c.product === product) c[field] = text; }); syncToCloud(); }
        
        function renderRegistry() {
            const container = document.getElementById('bmid-registry-container');
            if(!container) return;
            container.innerHTML = `<div class="card overflow-hidden"><table class="w-full text-left text-sm" id="registry-table"><thead class="bg-[#f4f7fe] uppercase text-[10px] font-bold text-rc-navy"><tr><th class="p-6">Date Logged</th><th class="p-6">Month</th><th class="p-6">Year</th><th class="p-6">Product</th><th class="p-6 text-xs font-bold">Campaign Name</th><th class="p-6 text-xs font-bold">BMID</th><th class="p-6 text-xs font-bold">Vendor</th><th class="p-6 text-xs font-bold">TCP L1</th><th class="p-6 text-xs font-bold">TCP L3</th></tr></thead><tbody class="divide-y divide-[#e2e8f0]" id="registry-body"></tbody></table></div>`;
            const body = document.getElementById('registry-body');
            (window.bmidRegistry || []).forEach(item => { 
                const row = document.createElement('tr'); 
                row.innerHTML = `<td class="p-6 font-medium text-gray-400 text-xs">${item.date}</td><td class="p-6 font-bold text-rc-blue text-xs">${item.month||'-'}</td><td class="p-6 font-bold text-rc-blue text-xs">${item.year||'-'}</td><td class="p-6 font-bold text-ocean text-xs">${item.product||'-'}</td><td class="p-6 font-bold text-ocean text-xs">${item.name}</td><td class="p-6 font-mono text-rc-blue text-xs font-bold">${item.bmid}</td><td class="p-6 font-semibold text-warm-black text-xs">${item.vendor}</td><td class="p-6 text-xs font-bold text-gray-400">${item.tcpL1||'-'}</td><td class="p-6 text-xs font-bold text-gray-400">${item.tcpL3||'-'}</td>`; 
                body.appendChild(row); 
            });
        }

        function notify(msg) { const area = document.getElementById('notification-area'); const toast = document.createElement('div'); toast.className = `p-4 rounded-xl bg-indigo-900 text-white text-xs font-bold shadow-2xl flex items-center space-x-3 transform transition-all duration-300 translate-x-full border-l-4 border-rc-orange`; toast.innerHTML = `<span>${msg}</span>`; area.appendChild(toast); setTimeout(() => toast.classList.remove('translate-x-full'), 10); setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000); }
        window.addEventListener('tabChanged', (e) => { if (e.detail === 'active-campaigns') renderCampaignHub(); if (e.detail === 'bmid-history') renderRegistry(); });

        initCloudSync(); 
        window.updateNaming();
    </script>
</body>
</html>
